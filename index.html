<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- 设置viewport视窗的宽度等于设备宽度，initial-scale=1 表示页面初始缩放比例为1 -->
    <title>Test</title>
  </head>
  <body>
<!-- Test Function -->            <!-- 这是一个测试函数，注释不会影响页面显示 -->
<input type="text" id="input">   <!-- 文本框，ID 为 input -->
<button type="button" id="btn">Send</button>                                    <!-- 按钮，类型为 button，ID 为 btn，文本为 Send -->
<ul id="ul"></ul>                                                               <!-- 无序列表，ID 为 ul -->
<br>   <!-- 换行符 -->
<p>Select a file:  <input type="file" id="uplaodsFile" name="uploadsFile"></p>   <!-- 段落，包含文本 Select a file 和一个文件上传输入框，ID 为 uplaodsFile，name 为 uploadsFile -->
<button type="button" id="uplaodFile">Upload</button>                            <!-- 按钮，类型为 button，ID 为 uplaodFile，文本为 Upload -->
<br>   <!-- 换行符 -->
<button type="button" id="uploadutf8">Upload Unit8Array</button>                 <!-- 按钮，类型为 button，ID 为 uploadutf8，文本为 Upload Unit8Array -->
<br>   <!-- 换行符 -->
<button type="button" id="uplaodString">Upload String</button>                   <!-- 按钮，类型为 button，ID 为 uplaodString，文本为 Upload String -->
<br>   <!-- 换行符 -->
<button type="button" id="delete">Delete</button>                                <!-- 按钮，类型为 button，ID 为 delete，文本为 Delete -->
<br>   <!-- 换行符 -->
<button type="button" id="show">Show Image</button>                              <!-- 按钮，类型为 button，ID 为 show，文本为 Show Image -->
<br>   <!-- 换行符 -->
<button type="button" id="next">Next Page</button>                               <!-- 按钮，类型为 button，ID 为 next，文本为 Next Page -->
<ul id="imgUl"></ul>                                                             <!-- 无序列表，ID 为 imgUl -->
<img id="shown_img" src="#" alt="">                                              <!-- 图片，ID 为 shown_img，初始路径为空，alt 属性为空字符串 -->


<!-- Import the basic jquery lib. -->   <!-- 导入基本的 jQuery 库 -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>                           <!-- 导入 jQuery 库的文件地址 -->
<!-- Import the associated firebase lib which the order is fixed. -->                         <!-- 导入相关的 Firebase 库，顺序固定 -->
<script defer src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>        <!-- 导入 Firebase 库中的 app 模块 -->
<script defer src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"></script>       <!-- 导入 Firebase 库中的 auth 模块 -->
<script defer src="https://www.gstatic.com/firebasejs/8.0.1/firebase-storage.js"></script>    <!-- 导入 Firebase 库中的 storage 模块 -->
<script defer src="https://www.gstatic.com/firebasejs/8.0.1/firebase-database.js"></script>   <!-- 导入 Firebase 库中的 database 模块 -->
<!-- Set the firebsae config and initialize it. -->                                           <!-- 设置 Firebase 的配置并初始化 Firebase -->
<script defer src="init-firebase.js"></script>                                                <!-- 导入初始化 Firebase 的脚本，defer 属性表示脚本将在页面完成解析后再执行 -->
<!-- Test Code -->   <!-- 这是一个测试代码块 -->

<script>
    // Variables  // 定义变量
    var usr = {};

    $(document).ready(function() {                // 页面加载后执行函数
        var dbRef = firebase.database();          // firebase.database() is jquery language. // 初始化数据库引用
        var msgRef = dbRef.ref('/messages/');     // 获取 messages 节点的引用
        
        // Database - CRUD  // 数据库操作 - 增删改查
        // Push (C)  // 增加（创建）
        $('#btn').on('click', function() {        // 点击按钮触发事件
            var msg = $('#input').val();          // 获取输入框中的值
            
            msgRef.push({                         // 将输入框中的值添加到数据库中
                account: msg
            });
        });
        
        // Read (R)  // 读取
        msgRef.on('value', function(snapshot) {  // 监听数据变化
            var val = snapshot.val();            // 获取数据库中的数据
            let list = '';
            
            $.each(val, function(i, item) {      // 遍历数据库中的数据
                console.log('each: ', i, item.message);
                list = `${list}<li>${item.message}`;
                    list += `<button type="button" class="remove" data-key="${i}">Remove</button>`;  // 添加删除按钮
                    list += `<input id="input_${i}"></input>`;                                       // 添加输入框
                    list += `<button type="button" class="update" data-key="${i}">Update</button>`;  // 添加更新按钮
                    list += `</li>`;
                });
                $('#ul').html(list);  // 将遍历后的数据添加到页面中
            });
    });
</script>

            
            // Update (U)
            $('#ul').on('click', '.update', function() {
                var key = $(this).data('key');
                var newMsg = $('#input_' + key).val();
                var postData = {
                    message: newMsg
                }
                var updates = {};
                updates['/messages/' + key] = postData;
                firebase.database().ref().update(updates);
            });
            
            // Delete (D)
            $('#ul').on('click', '.remove', function(){
                var key = $(this).data('key');
                msgRef.child(key).remove();
            });
            
            // Storage - CRUD
            var strgRef = firebase.storage().ref('/uploads/');
            
            var metadata =  {
                contentType: 'image/jepg'
            }
            
            // Push (C) - File & Image
            $('#uplaodFile').on('click', function() {
                var file = $('#uplaodsFile').prop('files')[0];
                var imgRef = strgRef.child(file.name);
                
                // console.log(file);
                
                imgRef.put(file).then(function(snapshot) {
                    console.log('Uploaded a blob or file!');
                });
                
            });

            // Push (C) - Unit8Array
            $('#uploadutf8').on('click', function() {
                var u8aRef = firebase.storage().ref('Unit8Array').child('test');
                // Uint8Array
                var bytes = new Uint8Array([0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21]);
                u8aRef.put(bytes).then(function(snapshot) {
                    console.log('Uploaded an array!');
                });
            });

            // Push (C) - String
            $('#uplaodString').on('click', function() {
                var strRef = firebase.storage().ref('String').child('00001');

                var msg = '5b6p5Y+344GX44G+44GX44Gf77yB44GK44KB44Gn44Go44GG77yB';
                strRef.putString(msg, 'base64').then(function(snapshot) {
                    console.log('Uploaded a base64 string!');
                });
            });
            

            // Read (R)


            // Download (R)
            $('#show').on('click', function() {
                var imgName = 'USPS.jpg'
                var pathRef = strgRef.child(imgName);
                // var gsRef = firebase.storage().refFromURL('gs://bucket/uploads/' + imgName);
                // var httpRef = firebase.storage().refFromURL('https://firebasestorage.googleapis.com/b/bucket/o/uploads/' + imgName);

                pathRef.getDownloadURL().then(function(url) {
                    console.log(url);

                    // This can be downloaded directly:
                    // var xhr = new XMLHttpRequest();
                    // xhr.responseType = 'blob';
                    // xhr.onload = function(event) {
                    //     var blob = xhr.response;
                    // };
                    // xhr.open('GET', url);
                    // xhr.send();

                    // $('#shown_img').attr('src', url);
                    var img = document.getElementById('shown_img');
                    img.src = url;
                }).catch(function(e) {
                    switch(e.code) {
                        case 'storage/object-not-found':
                        // File doesn't exist
                        break;

                        case 'storage/unauthorized':
                        // User doesn't have permission to access the object
                        break;

                        case 'storage/canceled':
                        // User canceled the upload
                        break;

                        case 'storage/unknown':
                        // Unknown error occurred, inspect the server response
                        break;
                    }
                });

            });
            
            // Delete (D)
            $('#delete').on('click', function() {
                var delImgRef = strgRef.child('Cover.png');

                delImgRef.delete().then(function() {
                    console.log('Delete Image.');
                }).catch(function(e) {
                    console.log(e);
                });
            });
            
            // Cookie
            $('#next').on('click', function() {
                document.cookie = "username=RobbenHsieh";
                window.location.replace('html/receieve.html');
                console.log("1st Page: " + document.cookie);
            });

        });
    </script>
  </body>
</html>
